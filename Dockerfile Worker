FROM centos:7

RUN yum install -y java-1.8.0-openjdk-devel

RUN yum install -y openssh-server openssh-clients wget


ENV JAVA_HOME /usr/lib/jvm/java-openjdk
ENV PATH $PATH:$JAVA_HOME/bin
ENV HADOOP_HOME=/opt/hadoop-3.1.2
ENV HADOOP_HDFS_HOME=$HADOOP_HOME
ENV HADOOP_COMMON_HOME=$HADOOP_HOME
ENV HADOOP_YARN_HOME=$HADOOP_HOME
ENV HADOOP_MAPRED_HOME=$HADOOP_HOME




RUN wget https://archive.apache.org/dist/hadoop/common/hadoop-3.1.2/hadoop-3.1.2.tar.gz && \
tar -xzf hadoop-3.1.2.tar.gz && \
mv hadoop-3.1.2 /opt && \
rm hadoop-3.1.2.tar.gz

RUN echo "Host *" > /etc/ssh_config
RUN echo "UserKnownHostsFile /dev/null" >> /etc/ssh_config
RUN echo "StrictHostKeyChecking no" >> /etc/ssh_config


RUN rm -f /etc/ssh/ssh_host_dsa_key /etc/ssh/ssh_host_rsa_key /root/.ssh/id_rsa
RUN ssh-keygen -q -N "" -t dsa -f /etc/ssh/ssh_host_dsa_key
RUN ssh-keygen -q -N "" -t rsa -f /etc/ssh/ssh_host_rsa_key
RUN ssh-keygen -q -N "" -t rsa -f /root/.ssh/id_rsa
RUN cp /root/.ssh/id_rsa.pub /root/.ssh/authorized_keys

RUN groupadd hadoop

RUN useradd hdfs -g hadoop -s /bin/bash
RUN cp -r /root/.ssh /home/hdfs/.ssh
RUN chown -R hdfs:hadoop /home/hdfs

RUN useradd yarn -g hadoop -s /bin/bash
RUN cp -r /root/.ssh /home/yarn/.ssh
RUN chown -R yarn:hadoop /home/yarn

RUN useradd hadoop -g hadoop -s /bin/bash
RUN cp -r /root/.ssh /home/hadoop/.ssh
RUN chown -R hadoop:hadoop /home/hadoop

RUN chown -R :hadoop /opt/hadoop-3.1.2


# Slave node
RUN mkdir /opt/datanode-dir && mkdir /opt/nodemanager-local-dir && mkdir /opt/nodemanager-log-dir && chown hdfs:hadoop /opt/datanode-dir && chown yarn:hadoop /opt/nodemanager-local-dir && chown yarn:hadoop /opt/nodemanager-log-dir


ADD https://gist.githubusercontent.com/rdaadr/64b9abd1700e15f04147ea48bc72b3c7/raw/2d416bf137cba81b107508153621ee548e2c877d/core-site.xml \
$HADOOP_HOME/etc/hadoop

ADD https://gist.githubusercontent.com/rdaadr/2f42f248f02aeda18105805493bb0e9b/raw/6303e424373b3459bcf3720b253c01373666fe7c/hadoop-env.sh \
$HADOOP_HOME/etc/hadoop

ADD https://gist.githubusercontent.com/rdaadr/2bedf24fd2721bad276e416b57d63e38/raw/640ee95adafa31a70869b54767104b826964af48/hdfs-site.xml \
$HADOOP_HOME/etc/hadoop

ADD https://gist.githubusercontent.com/rdaadr/aade84d36507817ba99085c9e1598151/raw/0d92f42c9ddde8e6d14671a09543df0ed5096224/yarn-site.xml \
$HADOOP_HOME/etc/hadoop


RUN sed -i 's#"%PATH_TO_OPENJDK8_INSTALLATION%"#/usr/lib/jvm/java-openjdk/#' $HADOOP_HOME/etc/hadoop/hadoop-env.sh
RUN sed -i 's#"%PATH_TO_HADOOP_INSTALLATION"#/opt/hadoop-3.1.2#' $HADOOP_HOME/etc/hadoop/hadoop-env.sh
RUN sed -i 's#"%HADOOP_HEAP_SIZE%"#512M#' $HADOOP_HOME/etc/hadoop/hadoop-env.sh
RUN sed -i 's#%HDFS_NAMENODE_HOSTNAME%#headnode#' $HADOOP_HOME/etc/hadoop/core-site.xml
RUN sed -i 's#host1#headnode#' $HADOOP_HOME/etc/hadoop/yarn-site.xml
RUN sed -i 's#%NODE_MANAGER_LOG_DIR%#/opt/nodemanager-log-dir#' $HADOOP_HOME/etc/hadoop/yarn-site.xml
RUN sed -i 's#%NODE_MANAGER_LOCAL_DIR%#/opt/nodemanager-local-dir#' $HADOOP_HOME/etc/hadoop/yarn-site.xml
RUN sed -i 's#%NAMENODE_DIRS%#/opt/namenode-dir#' $HADOOP_HOME/etc/hadoop/hdfs-site.xml
RUN sed -i 's#%DATANODE_DIRS%#/opt/datanode-dir#' $HADOOP_HOME/etc/hadoop/hdfs-site.xml

RUN echo "#!/bin/bash" > start-hadoop.sh && echo "$HADOOP_HOME/bin/hdfs --daemon start datanode" >> start-hadoop.sh && echo "$HADOOP_HOME/bin/yarn --daemon start nodemanager" >> start-hadoop.sh && echo "tail -f /dev/null" >> start-hadoop.sh

VOLUME /opt/datanode-dir /opt/nodemanager-local-dir /opt/nodemanager-log-dir

EXPOSE 22

EXPOSE 8020 8031 8032 8033 8040 8042 8088 8188

EXPOSE 9871 9870 9820 9869 9868 9867 9866 9865 9864

CMD bash start-hadoop.sh
